<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<!--
An element providing a solution to no problem in particular.

Example:

    <select-single name="user_id" selected="" backend="http://demo9131812.mockable.io/items">
        
    </select-single>

@demo
-->
<dom-module id="select-single">

  <style>
    :host {
      display: block;
      box-sizing: border-box;
    }

    ul {

        display: inline;
    }

    .item {

        border-top: 1px solid;
        padding: 3px;
        margin: 0;
        display: block;
        cursor: pointer;
        background: #fff;
    }

    input:focus {

        background: #eee;
    }

    .item.active,
    .item:hover,
    .item:focus {

        background: #eee;
    }

    #container {
        position: relative;
        display: block;
        z-index: 9999;
    }  

    #container input {
        display: block;
    }   

    #result {
        position: absolute;
        top: 20px;
        left: 0;
        width: 100%;
        padding: 0;
    }

   
    #selected {
      border: 1px solid #EEE;
      padding: 2px;
     display: inline-block;
   }

</style>

  <template>

    <template is="dom-if" if="{{selected}}">
       
        <div id="selected">
 
            <strong><span>{{selected.title}}</span></strong> <span>{{selected.id}}</span>
            <button on-click="reset">X</button>
            <input type="hidden" name$="{{name}}" value$="{{selected.id}}" />

        </div>

    </template>

    <div id="container">

        <input id="query" on-keyup="setajax" type="text" value="" autocomplete="off"/>

        <div id="result"><template id="resultlist" is="dom-repeat" items="{{items}}">
            <span class$="[[arrayItem(items.*,index,'class')]]"  on-click="select_click" result-id$="{{ index }}">[[item.title]]</span>
        </template></div>

    </div>

   <iron-ajax
    id="backend"
    handle-as="json"
    on-response="hresponse"
    debounce-duration="250"></iron-ajax> 

    <iron-a11y-keys target="{{}}" keys="pagedown down" on-keys-pressed="select_down"></iron-a11y-keys>
    <iron-a11y-keys target="{{}}" keys="pageup up"     on-keys-pressed="select_up"></iron-a11y-keys>
    <iron-a11y-keys target="{{}}" keys="enter"         on-keys-pressed="select_enter"></iron-a11y-keys>


  </template>

</dom-module>

<script>

  Polymer({

    is: 'select-single',

    update_items: function() {

        var these = this;
       
        var new_items = [];

        these.items.forEach(function(item,idx,arr) {

            item.class = "item";

            if ( idx === these.preselected ) {

                item.class = "item active";
            }
        
            these.set('items.'+idx+ '.class' ,item.class);
            
        });
    },

    arrayItem: function(change, index, path) {
        // this.get(path, root) returns a value for a path
        // relative to a root object.
        return this.get(path, change.base[index]);
    },

    select_enter: function(e) {
       
        e.preventDefault();

        var idx             = this.preselected;
        this.select_set(this.items[idx]);
        return false;
    },

    
    select_click: function(e) {

        e.preventDefault();

        // get the result-id from the clicked target
        var idx             = e.target.attributes.getNamedItem('result-id').value;
        this.select_set(this.items[idx]);
    },

    select_set: function(set) {

        this.selected       = set;
        this.$.query.value  = "";
        this.items          = [];

        if ( this.hide_on_select )  {
            this.$.query.style.display = "none";
        }

    },


    select_down: function(e) {


        if (this.items.length === 0) 
            return;

        if (this.preselected < (this.items.length - 1 )) {
        
            this.preselected++;

        } else { 

            this.preselected = -1;
        }
            
        this.update_items();
        
            
        return false;
    },


    select_up: function(e) {

        if (this.items.length === 0) 
            return;
            
        if (this.preselected > -1) {
         
            this.preselected--; 
        }

        this.update_items();
        
        return false;
    },

    setajax: function(e) {
        
        e.preventDefault();
       

        if( this.query !== this.$.query.value && this.$.query.value !== "" ) {      

            this.query = this.$.query.value;
       
            this.$.backend.params = { query: this.query };
            this.$.backend.generateRequest();
        }
    },

    reset: function(e) {

        e.preventDefault();

        this.selected = undefined;
        this.items    = [];
    
        if ( this.hide_on_select ) {
            this.$.query.style.display = "inline-block";
            this.$.query.focus();
        }

        return false;
    },

    hresponse: function(request) {
  
        // assign items to current instance
        this.items       = request.detail.response.items;
        this.update_items();
    },

    properties: {

      /**
       * `multiple` indicates that the element should handle more then one value.
       * NOT IMPLEMENTED
       */
        multiple:  Boolean,


        /**
          * 'hide_on_select' - when selected, hide input
          */
        hide_on_select: {

            type: Boolean,
            value: true,
        },

        /**
        * 'selected' the current selected object
        */ 
        selected:  Object,
        
        /**
        * 'items' the list of items
        */        
        items:    {
            type:   Array,
            notify: true
        },
        
        /** 
        * 'name' cgi name
        */
        name: String,

        /** 
          * 'backend' - URL for the backend
        */
        backend:    String,
        
        /**
          * 
          */
        preselected: Number,

        query: String,
    },

 
    // Element Lifecycle

    ready: function() {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).

        this.$.backend.url = this.backend;


        if ( this.hide_on_select && this.selected !== undefined )  {
            this.$.query.style.display = "none";
        }


    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    // Element Behavior
  
  });

</script>
